"use strict";(self.webpackChunk_betterdiscord_docs=self.webpackChunk_betterdiscord_docs||[]).push([[9621],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),h=u(n),d=o,m=h["".concat(l,".").concat(d)]||h[d]||p[d]||i;return n?a.createElement(m,r(r({ref:t},c),{},{components:n})):a.createElement(m,r({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:o,r[1]=s;for(var u=2;u<i;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6421:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var a=n(7462),o=(n(7294),n(3905));const i={sidebar_position:1,description:"Patch other functions with your function."},r="Function Patching",s={unversionedId:"plugins/advanced/patching",id:"plugins/advanced/patching",title:"Function Patching",description:"Patch other functions with your function.",source:"@site/docs/plugins/advanced/patching.md",sourceDirName:"plugins/advanced",slug:"/plugins/advanced/patching",permalink:"/plugins/advanced/patching",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,description:"Patch other functions with your function."},sidebar:"pluginsSidebar",previous:{title:"Advanced",permalink:"/plugins/advanced"},next:{title:"Webpack Modules",permalink:"/plugins/advanced/webpack"}},l={},u=[{value:"Background",id:"background",level:2},{value:"What is a function patch?",id:"what-is-a-function-patch",level:3},{value:"Why would I use one?",id:"why-would-i-use-one",level:3},{value:"How can I patch a function?",id:"how-can-i-patch-a-function",level:3},{value:"BetterDiscord",id:"betterdiscord",level:4},{value:"Examples",id:"examples",level:2},{value:"Before",id:"before",level:3},{value:"Instead",id:"instead",level:3},{value:"After",id:"after",level:3}],c={toc:u},h="wrapper";function p(e){let{components:t,...n}=e;return(0,o.kt)(h,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"function-patching"},"Function Patching"),(0,o.kt)("p",null,"This guide goes over the concept of function patching also sometimes referred to as monkey patching. If you're already familiar with this concept, consider checking out the ",(0,o.kt)("a",{parentName:"p",href:"#examples"},"Examples")," that show the utility provided by ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi.Patcher"),"."),(0,o.kt)("h2",{id:"background"},"Background"),(0,o.kt)("h3",{id:"what-is-a-function-patch"},"What is a function patch?"),(0,o.kt)("p",null,'A function patch an advanced technique for plugins that allow you to modify existing functions including Discord\'s own functions. There are typically three different "kinds" of patches as well. There are ones where you run your own code ',(0,o.kt)("inlineCode",{parentName:"p"},"before")," the original function usually with the goal to modify the arguments before they are passed to the original function. There are patches meant to run ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," of the original function, taking full control over arguments, functionality, and return value. And there are ones meant to run ",(0,o.kt)("inlineCode",{parentName:"p"},"after")," the original function with the goal of modifying the return value before it is passed elsewhere."),(0,o.kt)("h3",{id:"why-would-i-use-one"},"Why would I use one?"),(0,o.kt)("p",null,"It's a great way to modify or extend Discord's functionality with your own while keeping integration mostly seemless. It can also act as a way to modify the way Discord works currently. Take the plugin ",(0,o.kt)("a",{parentName:"p",href:"https://betterdiscord.app/plugin/HideDisabledEmojis"},"HideDisabledEmojis")," for example, it uses function patching to modify the way Discord's internal functions work to stop trying to render emojis the user cannot use. Your possibilities for the plugins you can make increase exponentially, and the quality usually ends up being higher due to the tight integration with Discord."),(0,o.kt)("h3",{id:"how-can-i-patch-a-function"},"How can I patch a function?"),(0,o.kt)("p",null,"Unfortunately, you can't patch a function ",(0,o.kt)("em",{parentName:"p"},"directly"),", you have to modify the ",(0,o.kt)("em",{parentName:"p"},"reference")," to the function that other code uses. That means if your target function is just a locally or globally available function like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"function yourTarget() {}\n")),(0,o.kt)("p",null,"then you can't really affect it. However, if your target is part of an object in some way, like being contained in an imported module, you can overwrite that reference with your own function causing everyone to call your function instead."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'const someObject = {\n    yourTarget: function() {\n        console.log("red");\n    }\n};\n\nfunction targetUser() {\n    someObject.yourTarget();\n}\n\ntargetUser(); // Logs "red"\n\n// highlight-start\nfunction myNewFunction() {\n    console.log("green");\n}\n\nsomeObject.yourTarget = myNewFunction;\n// highlight-end\n\ntargetUser(); // Now logs "green"\n')),(0,o.kt)("p",null,"If you take a look at the highlighted section, we are creating a new function ",(0,o.kt)("inlineCode",{parentName:"p"},"myNewFunction")," that logs ",(0,o.kt)("inlineCode",{parentName:"p"},"green")," and assigning it to ",(0,o.kt)("inlineCode",{parentName:"p"},"someObject.yourTarget")," effectively overwriting the target function. That means when ",(0,o.kt)("inlineCode",{parentName:"p"},"targetUser")," is called again, your function gets run successfully because it references the ",(0,o.kt)("inlineCode",{parentName:"p"},"someObject")," object. This here is known as an ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," patch because it completely replaces the target. All patches start this way but can expanded to become a ",(0,o.kt)("inlineCode",{parentName:"p"},"before")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"after")," patch by storing a reference and calling the original function. This also opens the door to subpatches and multiple users, but that can get complicated very fast."),(0,o.kt)("h4",{id:"betterdiscord"},"BetterDiscord"),(0,o.kt)("p",null,"Luckily, BetterDiscord already has a system in place to manage multiple patches per function and allows you to target different patch types. This means if you want to do a ",(0,o.kt)("inlineCode",{parentName:"p"},"before")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"after")," patch, you no longer have to manually replace the function and retain references and call the original. All of this is done for you with ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi.Patcher"),". Let's take a look at how our example above could be done with this module."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'const someObject = {\n    yourTarget: function() {\n        console.log("red");\n    }\n};\n\nfunction targetUser() {\n    someObject.yourTarget();\n}\n\ntargetUser(); // Logs "red"\n\n// highlight-start\nBdApi.Patcher.instead("MyPlugin", someObject, "yourTarget", () => console.log("green"));\n// highlight-end\n\ntargetUser(); // Now logs "green"\n')),(0,o.kt)("p",null,"This code has the some effect as before, causing ",(0,o.kt)("inlineCode",{parentName:"p"},"targetUser")," to instead log ",(0,o.kt)("inlineCode",{parentName:"p"},"green"),". But lets take a closer look at the highlighted line. We have a call to ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi.Patcher.instead")," which indicates we want to create an ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," patch. We pass it ",(0,o.kt)("inlineCode",{parentName:"p"},'"MyPlugin"')," which is an identifier used later to help removed all your patches with ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi.Patcher.unpatchAll"),". Then we give it the target object ",(0,o.kt)("inlineCode",{parentName:"p"},"someObject")," and the key of our target inside that object ",(0,o.kt)("inlineCode",{parentName:"p"},"yourTarget")," and our new function to override the original. BetterDiscord takes care of the rest and even allows other plugins to patch on top of yours."),(0,o.kt)("h2",{id:"examples"},"Examples"),(0,o.kt)("p",null,"For all of these examples, our setup is the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'function someGlobal() {\n    console.log("global function");\n    return 2;\n}\n\nconst someModule = {\n    value: "foobar",\n    method(val = 0) {\n        const globalValue = someGlobal();\n        return globalValue + 1 + val;\n    },\n    otherMethod(someArg) {\n        console.log(`My value ${someArg}`);\n    }\n};\n')),(0,o.kt)("p",null,"In this setup, ",(0,o.kt)("inlineCode",{parentName:"p"},"someGlobal")," is a function that cannot be patched because there is no reference to replace. However ",(0,o.kt)("inlineCode",{parentName:"p"},"someModule.method")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"someModule.otherMethod")," can both be patched."),(0,o.kt)("h3",{id:"before"},"Before"),(0,o.kt)("p",null,"If there's a function you want to modify the arguments for, a ",(0,o.kt)("inlineCode",{parentName:"p"},"before")," patch is the right one for you. Take a look at this patch below."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'BdApi.Patcher.before("MyPlugin", someModule, "otherMethod", (thisObject, args) => {\n    console.log(args);\n});\n\nsomeModule.otherMethod("something");\n// > ["something"]\n// > My value something\n')),(0,o.kt)("p",null,"In this example we didn't modify the arguments, we just wanted to log them out to see what kind of values we might get. This is a good technique to help modify arguments selectively. Suppose we don't mind that ",(0,o.kt)("inlineCode",{parentName:"p"},"something")," is logged, but we don't like when ",(0,o.kt)("inlineCode",{parentName:"p"},"token")," is logged. How might that look?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'BdApi.Patcher.before("MyPlugin", someModule, "otherMethod", (thisObject, args) => {\n    const firstArgument = args[0];\n    // highlight-start\n    if (firstArgument === "token") {\n        args[0] = "redacted";\n    }\n    // highlight-end\n});\n\nsomeModule.otherMethod("something"); // > My value something\nsomeModule.otherMethod("token");     // > My value redacted\n')),(0,o.kt)("p",null,"This highlighted section checks when someone passes ",(0,o.kt)("inlineCode",{parentName:"p"},"token")," as the value to ",(0,o.kt)("inlineCode",{parentName:"p"},"otherMethod")," and replaces it with ",(0,o.kt)("inlineCode",{parentName:"p"},"redacted"),". Note the replacement that happens inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"if")," statement. This is another case of using a reference to overwrite, except this time it is in the ",(0,o.kt)("inlineCode",{parentName:"p"},"arguments")," array. This is something to keep in mind as you do more ",(0,o.kt)("inlineCode",{parentName:"p"},"before")," patches."),(0,o.kt)("h3",{id:"instead"},"Instead"),(0,o.kt)("p",null,"You may have already seen a basic ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," patch in the ",(0,o.kt)("a",{parentName:"p",href:"#how-can-i-patch-a-function"},"section above")," but let's take a look at a slightly more complex version."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'function myFunction(val) {\n    console.log(`Intercepted ${val}`);\n}\n\nBdApi.Patcher.instead("MyPlugin", someModule, "method", (thisObject, args, originalFunction) => {\n    const firstArgument = args[0];\n    if (firstArgument === 5) return originalFunction(...args);\n    if (firstArgument === 1) return myFunction(...args);\n});\n\nsomeModule.method(5); // > 8\nsomeModule.method(1); // > Intercepted other\nsomeModule.method(1); // > undefined\n')),(0,o.kt)("p",null,"Take alook at the function we define in the ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," patch. We have a new parameter ",(0,o.kt)("inlineCode",{parentName:"p"},"originalFunction")," that BetterDiscord gives us to use as we see fit. In this example we use it for a specific value. If the value is ",(0,o.kt)("inlineCode",{parentName:"p"},"5")," we let the original function run and return without modification. If the value is ",(0,o.kt)("inlineCode",{parentName:"p"},"1")," we pass it to an external function and let that handle the arguments and the return. Otherwise, the function has no return value at all. This is a huge change to the function. It used to always return a value and now it only returns values for two cases. This is a good demonstration how much power function patching can have."),(0,o.kt)("h3",{id:"after"},"After"),(0,o.kt)("p",null,"This type of patch is perhaps the most frequently used in plugins, but if you've stuck with us for the first two, this one will be easy to get the hang of."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'BdApi.Patcher.after("MyPlugin", someModule, "method", (thisObject, args, returnValue) => {\n    return returnValue * 2;\n});\n\nsomeModule.method(5); // > 16\nsomeModule.method();  // > 6\n')),(0,o.kt)("p",null,"You'll notice that ",(0,o.kt)("inlineCode",{parentName:"p"},"originalFunction")," from before has turned into ",(0,o.kt)("inlineCode",{parentName:"p"},"returnValue"),". Here we simply multiply that by ",(0,o.kt)("inlineCode",{parentName:"p"},"2")," every time and return the value to the caller. So that means for any number we pass, the original function applies and returns, then our patch picks up that value and multiplies by ",(0,o.kt)("inlineCode",{parentName:"p"},"2"),", then the function caller finally gets their value. The BetterDiscord ",(0,o.kt)("inlineCode",{parentName:"p"},"Patcher")," will use whatever ",(0,o.kt)("inlineCode",{parentName:"p"},"return")," value you use. However if you ",(0,o.kt)("em",{parentName:"p"},"don't")," return anything, then the original return value is used. This can have profound effects. Consider this case below:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const myNewNumber = 5 / someModule.method(5);\n")),(0,o.kt)("p",null,"Now let's switch up our return value for only ",(0,o.kt)("inlineCode",{parentName:"p"},"5"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'BdApi.Patcher.after("MyPlugin", someModule, "method", (thisObject, args, returnValue) => {\n    if (args[0] === 5) return {};\n});\n')),(0,o.kt)("p",null,"In our patch this time, we ",(0,o.kt)("inlineCode",{parentName:"p"},"return")," a value only in the case of ",(0,o.kt)("inlineCode",{parentName:"p"},"5"),", in all other cases the default ",(0,o.kt)("inlineCode",{parentName:"p"},"return")," of the original function is used because we didn't return anything. If we wanted to stop that we could put a ",(0,o.kt)("inlineCode",{parentName:"p"},"return null;")," on the next line. You may have also noticed that our return is no longer a value. So what happens to our case above?"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js",metastring:"showLineNumbers",showLineNumbers:!0},'BdApi.Patcher.after("MyPlugin", someModule, "method", (thisObject, args, returnValue) => {\n    if (args[0] === 5) return {};\n});\n\nconst myNewNumber = 5 / someModule.method(5); // NaN\n')),(0,o.kt)("p",null,"This lead ",(0,o.kt)("inlineCode",{parentName:"p"},"myNewNumber")," to become ",(0,o.kt)("inlineCode",{parentName:"p"},"NaN")," or ",(0,o.kt)("em",{parentName:"p"},"not a number"),". Which is ironic considering the variable name. But it's a good example of how careful we need to be when it comes to modifying the returns of functions."))}p.isMDXComponent=!0}}]);